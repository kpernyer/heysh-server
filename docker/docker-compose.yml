version: '3.8'

services:
  # Temporal server
  temporal:
    image: temporalio/auto-setup:latest
    ports:
      - "7233:7233"
    environment:
      - DB=postgres12
      - DB_PORT=5432
      - POSTGRES_USER=temporal
      - POSTGRES_PWD=temporal
      - POSTGRES_SEEDS=postgres
    depends_on:
      - postgres
    networks:
      - hey-sh-network

  # Temporal UI
  temporal-ui:
    image: temporalio/ui:latest
    ports:
      - "8090:8080"  # Using 8090 to avoid port conflicts
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
    depends_on:
      - temporal
    networks:
      - hey-sh-network

  # Neo4j graph database
  neo4j:
    image: neo4j:5-community
    ports:
      - "7474:7474"  # Browser
      - "7687:7687"  # Bolt
    environment:
      - NEO4J_AUTH=neo4j/password
      - NEO4J_PLUGINS=["graph-data-science","apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=gds.*,apoc.*
    volumes:
      - neo4j_data:/data
    networks:
      - hey-sh-network

  # Weaviate vector database
  weaviate:
    image: semitechnologies/weaviate:latest
    ports:
      - "8082:8080"
      - "50051:50051"  # gRPC port
    environment:
      - AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED=true
      - PERSISTENCE_DATA_PATH=/var/lib/weaviate
      - ENABLE_MODULES=text2vec-openai,generative-openai
      - DEFAULT_VECTORIZER_MODULE=text2vec-openai
      - OPENAI_APIKEY=${OPENAI_API_KEY:-}
    volumes:
      - weaviate_data:/var/lib/weaviate
    networks:
      - hey-sh-network

  # PostgreSQL (for Temporal)
  postgres:
    image: postgres:15
    ports:
      - "5433:5432"  # Using 5433 to avoid conflict with system PostgreSQL
    environment:
      - POSTGRES_USER=temporal
      - POSTGRES_PASSWORD=temporal
      - POSTGRES_DB=temporal
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - hey-sh-network

  # Backend API (optional, for local development)
  # backend:
  #   build:
  #     context: ..
  #     dockerfile: docker/Dockerfile
  #   ports:
  #     - "8000:8000"
  #   environment:
  #     - TEMPORAL_ADDRESS=temporal:7233
  #     - NEO4J_URI=bolt://neo4j:7687
  #     - WEAVIATE_URL=http://weaviate:8080
  #     - POSTGRES_HOST=postgres
  #   env_file:
  #     - ../.env
  #   depends_on:
  #     - temporal
  #     - neo4j
  #     - weaviate
  #     - postgres
  #   networks:
  #     - hey-sh-network

volumes:
  neo4j_data:
  weaviate_data:
  postgres_data:

networks:
  hey-sh-network:
    driver: bridge
